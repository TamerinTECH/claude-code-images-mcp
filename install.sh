#!/bin/bash

# Claude Code Image Generation Agent - Installation Script (Unix/Linux/macOS)
# Copyright (c) 2025 TamerinTECH GmbH
# MIT License

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Banner
echo -e "${BLUE}"
echo "╔═══════════════════════════════════════════════════════════╗"
echo "║   Claude Code Image Generation Agent - Installer         ║"
echo "║   TamerinTECH GmbH                                        ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo -e "${NC}"

# Function to print success
success() {
    echo -e "${GREEN}✓${NC} $1"
}

# Function to print error
error() {
    echo -e "${RED}✗${NC} $1"
}

# Function to print info
info() {
    echo -e "${BLUE}ℹ${NC} $1"
}

# Function to print warning
warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

# Check if Node.js is installed
info "Checking prerequisites..."
if ! command -v node &> /dev/null; then
    error "Node.js is not installed"
    echo ""
    echo "Please install Node.js 18.0.0 or higher from:"
    echo "https://nodejs.org/"
    exit 1
fi

# Check Node.js version
NODE_VERSION=$(node -v | cut -d'v' -f2)
REQUIRED_VERSION="18.0.0"

if [ "$(printf '%s\n' "$REQUIRED_VERSION" "$NODE_VERSION" | sort -V | head -n1)" != "$REQUIRED_VERSION" ]; then
    error "Node.js version $NODE_VERSION is too old"
    echo "Required: Node.js >= 18.0.0"
    echo "Please upgrade Node.js from https://nodejs.org/"
    exit 1
fi

success "Node.js $NODE_VERSION found"

# Check if npm is installed
if ! command -v npm &> /dev/null; then
    error "npm is not installed"
    exit 1
fi

success "npm $(npm -v) found"

# Install dependencies
echo ""
info "Installing dependencies..."
npm install

if [ $? -eq 0 ]; then
    success "Dependencies installed successfully"
else
    error "Failed to install dependencies"
    exit 1
fi

# Create .env file
echo ""
if [ -f ".env" ]; then
    warning ".env file already exists!"
    echo ""
    echo "What would you like to do?"
    echo "1) Keep existing .env file (recommended)"
    echo "2) Reconfigure (backup existing and create new)"
    echo "3) Skip for now"
    echo ""
    read -p "Choose option (1/2/3): " -n 1 -r
    echo ""

    if [[ $REPLY == "2" ]]; then
        # Backup existing file
        BACKUP_FILE=".env.backup.$(date +%Y%m%d_%H%M%S)"
        cp .env "$BACKUP_FILE"
        success "Existing .env backed up to $BACKUP_FILE"

        # Prompt for new credentials
        echo ""
        echo "Please enter your Azure OpenAI credentials:"
        echo ""
        read -p "Azure OpenAI Endpoint (e.g., https://your-resource.openai.azure.com): " AZURE_ENDPOINT
        read -p "Azure OpenAI API Key: " AZURE_KEY
        read -p "Azure OpenAI Deployment (default: flux-1-1-pro): " AZURE_DEPLOYMENT
        AZURE_DEPLOYMENT=${AZURE_DEPLOYMENT:-flux-1-1-pro}
        read -p "Azure OpenAI API Version (default: 2025-04-01-preview): " AZURE_VERSION
        AZURE_VERSION=${AZURE_VERSION:-2025-04-01-preview}

        # Create new .env file
        cat > .env << EOF
# Azure OpenAI Configuration for Image Generation
# Generated by installer on $(date)

# Azure OpenAI Endpoint (required)
AZURE_OPENAI_ENDPOINT=$AZURE_ENDPOINT

# Azure OpenAI API Key (required)
AZURE_OPENAI_API_KEY=$AZURE_KEY

# Azure OpenAI Deployment Name
AZURE_OPENAI_DEPLOYMENT=$AZURE_DEPLOYMENT

# Azure OpenAI API Version
AZURE_OPENAI_API_VERSION=$AZURE_VERSION

# Output Directory for Generated Images (optional)
# OUTPUT_DIR=./generated-images
EOF

        success ".env file updated"
    elif [[ $REPLY == "3" ]]; then
        info "Skipping .env configuration"
        warning "You'll need to configure .env manually before using the agent"
    else
        success "Using existing .env file"
    fi
else
    echo "No .env file found."
    echo ""
    echo "Would you like to configure Azure OpenAI credentials now?"
    echo "1) Yes, configure now"
    echo "2) No, I'll add them later"
    echo ""
    read -p "Choose option (1/2): " -n 1 -r
    echo ""

    if [[ $REPLY == "1" ]]; then
        # Prompt for Azure OpenAI credentials
        echo ""
        echo "Please enter your Azure OpenAI credentials:"
        echo ""
        read -p "Azure OpenAI Endpoint (e.g., https://your-resource.openai.azure.com): " AZURE_ENDPOINT
        read -p "Azure OpenAI API Key: " AZURE_KEY
        read -p "Azure OpenAI Deployment (default: flux-1-1-pro): " AZURE_DEPLOYMENT
        AZURE_DEPLOYMENT=${AZURE_DEPLOYMENT:-flux-1-1-pro}
        read -p "Azure OpenAI API Version (default: 2025-04-01-preview): " AZURE_VERSION
        AZURE_VERSION=${AZURE_VERSION:-2025-04-01-preview}

        # Create .env file
        cat > .env << EOF
# Azure OpenAI Configuration for Image Generation
# Generated by installer on $(date)

# Azure OpenAI Endpoint (required)
AZURE_OPENAI_ENDPOINT=$AZURE_ENDPOINT

# Azure OpenAI API Key (required)
AZURE_OPENAI_API_KEY=$AZURE_KEY

# Azure OpenAI Deployment Name
AZURE_OPENAI_DEPLOYMENT=$AZURE_DEPLOYMENT

# Azure OpenAI API Version
AZURE_OPENAI_API_VERSION=$AZURE_VERSION

# Output Directory for Generated Images (optional)
# OUTPUT_DIR=./generated-images
EOF

        success ".env file created"
    else
        # Create template .env file
        info "Creating .env template..."
        cp .env.example .env
        success ".env template created"
        warning "Please edit .env and add your Azure OpenAI credentials before using the agent"
        echo "You can do this by running: nano .env"
    fi
fi

# Run tests
echo ""
read -p "Run unit tests to verify installation? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    info "Running unit tests..."
    npm run test:unit

    if [ $? -eq 0 ]; then
        success "All unit tests passed!"
    else
        warning "Some tests failed. Please check the output above."
    fi
fi

# Ask about Claude Code integration
echo ""
read -p "Add to Claude Code configuration? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    INDEX_PATH="$SCRIPT_DIR/src/index.js"

    info "Adding MCP server using claude mcp add command..."
    info "Configuration will be read from .env file"

    # Warn if .env doesn't exist
    ENV_PATH="$SCRIPT_DIR/.env"
    if [ ! -f "$ENV_PATH" ]; then
        warning ".env file not found at: $ENV_PATH"
        warning "The MCP server will be added but won't work until you create .env"
        echo ""
    fi

    # Check if claude command is available
    if ! command -v claude &> /dev/null; then
        warning "claude CLI not found. Please install Claude Code first."
    else
        # Build and execute the command - no env vars needed, reads from .env file
        CMD="claude mcp add --transport stdio image-generator -- node \"$INDEX_PATH\""

        # Debug: show what we're executing
        info "Running: $CMD"

        # Execute
        eval $CMD

        if [ $? -eq 0 ]; then
            success "MCP server added successfully"
            info "Configuration loaded from: $ENV_PATH"
            info "Verify with: claude mcp list"
        else
            error "Failed to add MCP server"
            echo ""
            info "You can manually add it with:"
            echo "claude mcp add --transport stdio image-generator -- node \"$INDEX_PATH\""
        fi
    fi
fi

# Create output directory
echo ""
info "Creating output directory..."
mkdir -p generated-images
success "Output directory created: generated-images/"

# Final success message
echo ""
echo -e "${GREEN}"
echo "╔═══════════════════════════════════════════════════════════╗"
echo "║   Installation Complete!                                  ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo -e "${NC}"
echo ""
echo "Next steps:"
echo "1. If you added to Claude Code config, restart Claude Code"
echo "2. Test the agent: npm run test:integration"
echo "3. Start generating images!"
echo ""
echo "Documentation: README.md"
echo "Support: info@tamerin.tech"
echo ""
