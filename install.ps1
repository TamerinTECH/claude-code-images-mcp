# Claude Code Image Generation Agent - Installation Script (PowerShell 5.1+)
# Copyright (c) 2025 TamerinTECH GmbH
# MIT License

$ErrorActionPreference = "Stop"

# Simple log helpers (ASCII only)
function WriteOk    { param([string]$m) Write-Host "[OK]    $m" -ForegroundColor Green }
function WriteErr   { param([string]$m) Write-Host "[ERROR] $m" -ForegroundColor Red }
function WriteInfo  { param([string]$m) Write-Host "[INFO]  $m" -ForegroundColor Cyan }
function WriteWarn  { param([string]$m) Write-Host "[WARN]  $m" -ForegroundColor Yellow }

# Utilities
function New-EnvFileContent {
    param(
        [string]$Provider,
        [string]$GeminiKey,
        [string]$AzureEndpoint,
        [string]$AzureKey,
        [string]$AzureDeployment,
        [string]$AzureApiVersion
    )
    $dt = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $lines = @(
        "# Image Generation Configuration"
        "# Generated by installer on $dt"
        ""
        "# Provider Selection (google or azure)"
        "IMAGE_PROVIDER=$Provider"
        ""
        "# ============================================"
        "# Google Gemini Configuration"
        "# ============================================"
        "# Get your API key at: https://aistudio.google.com/app/apikey"
        "GEMINI_API_KEY=$GeminiKey"
        ""
        "# ============================================"
        "# Azure OpenAI Configuration"
        "# ============================================"
        "AZURE_OPENAI_ENDPOINT=$AzureEndpoint"
        "AZURE_OPENAI_API_KEY=$AzureKey"
        "AZURE_OPENAI_DEPLOYMENT=$AzureDeployment"
        "AZURE_OPENAI_API_VERSION=$AzureApiVersion"
        ""
        "# Output Directory for Generated Images (optional)"
        "# OUTPUT_DIR=./generated-images"
    )
    return $lines
}

# Start
Write-Host ""
Write-Host "Claude Code Image Generation Agent - Installer"
Write-Host "----------------------------------------------"
Write-Host ""

# Check Node.js
WriteInfo "Checking Node.js..."
try {
    $nodeVersion = node -v 2>$null
    if ($LASTEXITCODE -ne 0 -or -not $nodeVersion) { throw "Node.js not found" }
    $nodeVersionNumber = $nodeVersion.TrimStart('v')
    $requiredVersion = [Version]"18.0.0"
    $currentVersion = [Version]$nodeVersionNumber
    if ($currentVersion -lt $requiredVersion) {
        WriteErr "Node.js $nodeVersionNumber is too old. Need >= 18.0.0"
        exit 1
    }
    WriteOk "Node.js $nodeVersionNumber found"
} catch {
    WriteErr "Node.js is not installed. Install from https://nodejs.org/"
    exit 1
}

# Check npm
WriteInfo "Checking npm..."
try {
    $npmVersion = npm -v 2>$null
    if ($LASTEXITCODE -ne 0 -or -not $npmVersion) { throw "npm not found" }
    WriteOk "npm $npmVersion found"
} catch {
    WriteErr "npm is not installed"
    exit 1
}

# Install dependencies
Write-Host ""
WriteInfo "Installing dependencies..."
try {
    npm install
    if ($LASTEXITCODE -ne 0) { throw "npm install failed" }
    WriteOk "Dependencies installed"
} catch {
    WriteErr "Failed to install dependencies"
    exit 1
}

# Defaults
$provider        = "google"
$geminiKey       = ""
$azureEndpoint   = ""
$azureKey        = ""
$azureDeployment = "flux-1-1-pro"
$azureVersion    = "2025-04-01-preview"

# .env handling
Write-Host ""
if (Test-Path ".env") {
    WriteWarn ".env file already exists"
    Write-Host "What would you like to do?"
    Write-Host "1) Keep existing .env file (recommended)"
    Write-Host "2) Reconfigure (backup and create new)"
    Write-Host "3) Skip for now"
    $choice = Read-Host "Choose option (1/2/3)"

    if ($choice -eq "2") {
        $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
        $backupFile = ".env.backup.$timestamp"
        Copy-Item ".env" $backupFile -Force
        WriteOk "Backed up to $backupFile"

        Write-Host ""
        Write-Host "Choose image generation provider:"
        Write-Host "1) Google Gemini (Nano Banana) - Default, fast, free-tier friendly"
        Write-Host "2) Azure OpenAI (Flux/gpt-image-1) - Alternative with more control"
        $provChoice = Read-Host "Choose provider (1/2, default: 1)"

        if ($provChoice -eq "2") {
            $provider = "azure"
            Write-Host ""
            Write-Host "Enter Azure OpenAI credentials:"
            $azureEndpoint   = Read-Host "Azure OpenAI Endpoint (e.g. https://your-resource.openai.azure.com)"
            $azureKey        = Read-Host "Azure OpenAI API Key"
            $tmp = Read-Host "Azure OpenAI Deployment (default: flux-1-1-pro)"
            if (-not [string]::IsNullOrWhiteSpace($tmp)) { $azureDeployment = $tmp }
            $tmp = Read-Host "Azure OpenAI API Version (default: 2025-04-01-preview)"
            if (-not [string]::IsNullOrWhiteSpace($tmp)) { $azureVersion = $tmp }
        } else {
            $provider = "google"
            Write-Host ""
            Write-Host "Enter Google Gemini API Key:"
            Write-Host "Get your key at: https://aistudio.google.com/app/apikey"
            $geminiKey = Read-Host "Gemini API Key"
        }

        $envLines = New-EnvFileContent -Provider $provider -GeminiKey $geminiKey -AzureEndpoint $azureEndpoint -AzureKey $azureKey -AzureDeployment $azureDeployment -AzureApiVersion $azureVersion
        Set-Content -Path ".env" -Value $envLines -Encoding ASCII
        WriteOk ".env file updated"
    }
    elseif ($choice -eq "3") {
        WriteInfo "Skipping .env configuration"
        WriteWarn "Make sure .env has valid values before using the agent"
    }
    else {
        WriteOk "Using existing .env file"
    }
}
else {
    Write-Host "No .env file found."
    Write-Host "1) Create and configure now"
    Write-Host "2) Create template and edit later"
    $choice = Read-Host "Choose option (1/2)"

    if ($choice -eq "1") {
        Write-Host ""
        Write-Host "Choose image generation provider:"
        Write-Host "1) Google Gemini (Nano Banana) - Default, fast, free-tier friendly"
        Write-Host "2) Azure OpenAI (Flux/gpt-image-1) - Alternative with more control"
        $provChoice = Read-Host "Choose provider (1/2, default: 1)"

        if ($provChoice -eq "2") {
            $provider = "azure"
            Write-Host ""
            Write-Host "Enter Azure OpenAI credentials:"
            $azureEndpoint   = Read-Host "Azure OpenAI Endpoint (e.g. https://your-resource.openai.azure.com)"
            $azureKey        = Read-Host "Azure OpenAI API Key"
            $tmp = Read-Host "Azure OpenAI Deployment (default: flux-1-1-pro)"
            if (-not [string]::IsNullOrWhiteSpace($tmp)) { $azureDeployment = $tmp }
            $tmp = Read-Host "Azure OpenAI API Version (default: 2025-04-01-preview)"
            if (-not [string]::IsNullOrWhiteSpace($tmp)) { $azureVersion = $tmp }
        } else {
            $provider = "google"
            Write-Host ""
            Write-Host "Enter Google Gemini API Key:"
            Write-Host "Get your key at: https://aistudio.google.com/app/apikey"
            $geminiKey = Read-Host "Gemini API Key"
        }

        $envLines = New-EnvFileContent -Provider $provider -GeminiKey $geminiKey -AzureEndpoint $azureEndpoint -AzureKey $azureKey -AzureDeployment $azureDeployment -AzureApiVersion $azureVersion
        Set-Content -Path ".env" -Value $envLines -Encoding ASCII
        WriteOk ".env file created"
    }
    else {
        WriteInfo "Creating .env template"
        $envLines = New-EnvFileContent -Provider "google" -GeminiKey "" -AzureEndpoint "" -AzureKey "" -AzureDeployment "flux-1-1-pro" -AzureApiVersion "2025-04-01-preview"
        Set-Content -Path ".env" -Value $envLines -Encoding ASCII
        WriteOk ".env template created"
        WriteWarn "Edit .env and add your API credentials"
    }
}

# Optional tests
Write-Host ""
$runTests = Read-Host "Run unit tests now (y/n)"
if ($runTests -eq 'y' -or $runTests -eq 'Y') {
    WriteInfo "Running unit tests..."
    try {
        npm run test:unit
        if ($LASTEXITCODE -eq 0) {
            WriteOk "All unit tests passed"

            # Offer to run live image generation test
            Write-Host ""
            $runLiveTest = Read-Host "Test live image generation with your API key (y/n)"
            if ($runLiveTest -eq 'y' -or $runLiveTest -eq 'Y') {
                WriteInfo "Running live image generation test..."
                WriteWarn "This will use your API quota and generate a test image"
                try {
                    $env:RUN_API_TESTS = "true"
                    npm run test:integration
                    if ($LASTEXITCODE -eq 0) {
                        WriteOk "Live image generation test passed!"
                        WriteInfo "Check the generated-images folder for test images"
                    }
                    else { WriteWarn "Live test failed - check your API key and quota" }
                } catch {
                    WriteWarn "Failed to run live test"
                } finally {
                    Remove-Item Env:\RUN_API_TESTS -ErrorAction SilentlyContinue
                }
            }
        }
        else { WriteWarn "Some tests failed, check output" }
    } catch { WriteWarn "Failed to run tests" }
}

# Claude Code integration
Write-Host ""
$addToConfig = Read-Host "Add MCP server to Claude Code (y/n)"
if ($addToConfig -eq 'y' -or $addToConfig -eq 'Y') {
    $scriptDir = $PSScriptRoot
    if (-not $scriptDir) { $scriptDir = Split-Path -Parent $MyInvocation.MyCommand.Path }
    $indexPath = Join-Path $scriptDir "src\index.js"

    WriteInfo "Adding MCP server using claude mcp add command..."
    WriteInfo "Configuration will be read from .env file"

    # Warn if .env doesn't exist
    $envPath = Join-Path $scriptDir ".env"
    if (-not (Test-Path $envPath)) {
        WriteWarn ".env file not found at: $envPath"
        WriteWarn "The MCP server will be added but won't work until you create .env"
        Write-Host ""
    }

    try {
        # Check if claude command is available
        $claudeCmd = Get-Command claude -ErrorAction SilentlyContinue
        if (-not $claudeCmd) {
            WriteWarn "claude CLI not found. Please install Claude Code first."
        } else {
            # Build the command - no env vars needed, reads from .env file
            WriteInfo "Running: claude mcp add --transport stdio image-generator -- node $indexPath"

            # Execute using direct command with properly quoted path
            claude mcp add --transport stdio image-generator -- node $indexPath

            if ($LASTEXITCODE -eq 0) {
                WriteOk "MCP server added successfully"
                WriteInfo "Configuration loaded from: $envPath"
                WriteInfo "Verify with: claude mcp list"
            } else {
                WriteErr "Failed to add MCP server"
                Write-Host ""
                WriteInfo "You can manually add it with:"
                Write-Host "claude mcp add --transport stdio image-generator -- node $indexPath"
            }
        }
    } catch {
        WriteErr "Error running claude mcp add: $_"
    }
}

# Create output directory
Write-Host ""
WriteInfo "Ensuring output directory exists..."
if (-not (Test-Path "generated-images")) {
    New-Item -ItemType Directory -Path "generated-images" -Force | Out-Null
}
WriteOk "Output directory ready: generated-images"

# Done
Write-Host ""
Write-Host "Installation complete."
Write-Host "Next steps:"
Write-Host "1. If you added config, restart Claude desktop."
Write-Host "2. Run: npm run test:integration"
Write-Host "3. Start generating images."
